require("reflect-metadata");
const { app, BrowserWindow, ipcMain } = require("electron");
const { resolve: _resolve } = require("path");
const { INJECTED_INSTANCE_METADATA } = require("./constants");

global.__VOXER_MAIN__ = true;

async function createWindow() {
    const win = new BrowserWindow({
        webPreferences: {
            preload: __dirname + "/preload.js",
            nodeIntegration: false,
            contextIsolation: true,
        },
    });

    <% if (isDev) { %>
    const resolve = _resolve.bind(_resolve, __dirname, "../view");
    <% } else { %>
    const resolve = _resolve.bind(_resolve, __dirname);
    <% } %>

    <% if (isTs) {  %>
    const { main, inject } = require("./dist/src/main.js");
    <% } else { %>
    const { main, inject } = require("../src/main.js");
    <% } %>
    await main(win, resolve);
    const injectables = await require("./inject")(inject);

    for (const injectable of injectables) {
        for (const method of injectable.__exposedMethods) {
            const eventName = injectable.name + "." + method;

            ipcMain.on(eventName, () => {
                const instance = Reflect.getMetadata(INJECTED_INSTANCE_METADATA, injectable);
                instance[method]();
            });
        }
    }

    if (!win.webContents.getURL()) {
        <% if (isDev) { %>
            <% if (isTs) {  %>
            const config = require("./dist/voxer.config.js").default;
            const { main } = require("./dist/src/main.js");
            <% } else { %>
            const config = require("../voxer.config.js");
            const { main } = require("../src/main.js");
            <% } %>
            win.loadURL("http://localhost:<%= config.vite?.port || 3000 %>");
        <% } else { %>
            win.loadFile(resolve("<%= "index.html" %>"));
        <% } %>
    }
}

app.whenReady().then(() => {
    createWindow();
    app.on("activate", () => {
        if (BrowserWindow.getAllWindows().length === 0) {
            createWindow();
        }
    });
});

app.on("window-all-closed", () => {
    if (process.platform !== "darwin") {
        app.quit();
    }
});
